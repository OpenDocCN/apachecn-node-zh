# 第七章。瓶颈

正如我们在前面几章中看到的，很多因素都会影响性能。甚至开发过程也会影响您监控性能下降的方式。您使用的模式可能不会在小范围内产生影响，但是在部署之后，您将会后悔您所做的每一个错误的决定。

主机也是一个重要的性能因素。处理器在特定任务中的表现非常重要。有多少可用内存会影响有多少数据将驻留在快速位置或移动到较慢的位置，如本地磁盘。

缓存数据也非常重要。使用某种中间存储加速数据访问的技术给人一种速度更快的感觉，这造成了一种快速应用的重要错觉。虽然这看起来可能是错误的，因为它看起来像一种幻觉，但如果你想将性能发挥到极限，这实际上非常重要。

所有这些都很重要，但是也有你无法通过的限制，或者至少有一些你应该知道的限制，以便去选择一个更好的设计模式。其中一些限制超出了您的范围，您无法调整或控制它们。如果你有预算和/或时间，并且想走这条路，其他的可以减到最少。我建议您接受它，因为了解您的应用的环境会让您更好地了解它是如何工作的，以及如何改进它。

# 主机限制

托管应用的地方(服务器)有限制。主机有两种限制:硬件和软件。硬件限制很容易发现。您的应用可能正在消耗所有内存，并且需要消耗磁盘才能继续工作。通过升级主机来增加更多的内存，无论是物理的还是虚拟的，似乎都是正确的选择。

对于 Node.js 应用，你也有一个由 V8 强加的软件内存限制，所以在升级你的内存库时不要忘记这一点。由于 32 位环境或多或少有 3.5 GB 的限制，我假设您正在 64 位环境中升级内存。在这种情况下，默认情况下，您的应用将以 1 GB 的 V8 限制运行。然后，您需要以更高的限制运行应用，方法是以类似于以下命令的方式启动它:

```js
$ node --max_old_space_size 4000 application

```

这将在 4 GB 内存限制下运行`application.js`。这其实是不推荐的。您可能选择了不适合任务的设计模式，您应该尝试将您的应用分割成更小的服务。

当您无法控制生产环境时，可能会有其他限制，例如无法安装软件依赖项或升级库以修复安全或性能问题。如果你不从上到下控制环境，你就没有发挥它的极限。

操作系统和数据库服务器通常带有用于适度使用的预定义值。这对普通用户来说通常没问题，但对超级用户来说肯定不够。

一个简单的例子是每个进程打开的文件描述符的最大数量。套接字是一个文件描述符，如果您使用默认的 1024 限制，这意味着您最多可能有 1000 个打开的客户端连接。我很慷慨；我说的是一台 Linux 机器。如果你看看 OS X，你会有一个更糟糕的情况。

类似于这个限制，特别是看一下 Linux，您可以查看肯定会影响您的应用的其他限制。看看手册，看看你可能想调整哪些选项。以下是您可能在 Linux 系统中找到的限制和默认值示例:

```js
$ ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 31692
max locked memory       (kbytes, -l) 64
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 31692
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited

```

您还可以针对您的应用更改和优化其他方法和选项。我说的是内核参数。您可以查看它们，并使用`sysctl`命令进行更改。

您可以调整区域，如文件系统、网络计时和路由、虚拟内存行为和内核本身，如处理器调度和对挂起任务的反应。

这里有一个小列表，只显示了一小部分选项:

```js
$ sysctl -a | tail
vm.overcommit_ratio = 50
vm.page-cluster = 3
vm.panic_on_oom = 0
vm.percpu_pagelist_fraction = 0
vm.scan_unevictable_pages = 0
vm.stat_interval = 1
vm.swappiness = 60
vm.user_reserve_kbytes = 131072
vm.vfs_cache_pressure = 100
vm.zone_reclaim_mode = 0

```

如前所述，不仅仅是操作系统会对您的用例进行糟糕的优化。服务通常附带一个简单的默认配置，该配置不以性能为目标。

MySQL 数据库服务器可以有一些怪异的配置参数，比如`innodb_flush_log_at_trx_commit`，默认为`1`。这意味着每个事务都会触发刷新磁盘(以保存事务)。如果您每秒有 100 个事务，这意味着您的磁盘将因每秒发出 100 次刷新而发热并降低性能。

相反，您可能希望确保这个配置是`2`，这意味着磁盘刷新每秒最多完成一次。这种配置并不能保证 ACID([https://en.wikipedia.org/wiki/ACID](https://en.wikipedia.org/wiki/ACID))合规，不过我想你以后会感谢我的。性能是有代价的，在这种情况下，需要不间断电源。

您必须注意的另一个配置是操作系统和应用中涉及的所有服务所使用的内存。例如，以 MySQL 服务器为例，您必须确保它不会消耗所有内存，并为您的其他服务留下一些内存。这避免了交换，并确保它平稳运行。

## 网络限制

如今，网络是访问应用的实际传输方式。随着物联网越来越成为现实，即使是常见的桌面应用，如办公生产力工具，也在向云迁移。你可能从来没有开发过传统的桌面应用。

与传统应用相比，云应用具有许多优势，例如:

*   更容易部署。由于应用位于一个或多个中心点，修复一个错误或向所有用户群添加一个特性会更简单。
*   许可证强制执行。由于应用没有安装在用户的计算机上，并且您控制主机，因此您可以阻止其使用或控制服务质量。
*   适当的环境。因为您控制主机，所以您要确保它有合适的处理器以及足够的内存和磁盘空间来正常运行。

所有这些都是非常好的优点，但是缺点呢？嗯，每一个优点，通常都有缺点。没什么好坏之分；这取决于你喜欢什么。根据前面的列表，我们可以列举出对应项:

*   部署时必须小心谨慎，因为服务器包含敏感数据，这是使用应用的唯一方式。你接受 Gmail 离线 15 分钟吗？为了保证正确的部署，您需要具有重复数据的适当基础架构，以确保您可以从网络池中删除服务器、更新它们并再次重新部署它们。
*   强制实施许可证意味着您可以保持服务在线，并且不允许停机。同样，您可能需要在用户使用应用时确保计费系统。这与普通的桌面应用相反，你只需支付一次，然后就忘了它。
*   使应用适应多种环境。支持所有主要的浏览器供应商并不容易。随之而来的是用户的假设，即您的应用必须有一个移动友好的替代品，这通常不存在于桌面版本中。

如果您喜欢不将应用迁移到云的优势，有很多市场优惠(免费和付费)可以将您的 web 应用“转换”为桌面应用。

应用现在更喜欢驻留在云中。它们的优势通常超过桌面应用，优势中提到了一些重要的东西——许可。云为您提供了“即服务”的机会，这是传统应用通常不具备的。

伴随着云而来的是许多辛苦和烦恼。您需要注册自己的域，支付专用或共享主机的费用，并部署您的应用。如果您正在开发一个大型应用，并希望实现您的承诺，您需要的不仅仅是这些:硬件、具有良好服务质量的网络链接、支持团队、备份计划等等。

无论你选择什么，都有你应该意识到的限制。你可能认识他们，但这从未反映出来。您有以下限制:

*   响应能力。当用户使用应用界面进行交互时，可能会感觉很慢，因为当用户使用界面时，界面是从云中下载的。如果将界面缓存在用户电脑中，可以提高这种响应性。缓存意味着有时用户可能会看到一个旧的界面，但这可能不如获得快速的用户体验那么重要。这样做是有标准的。以 HTML 标准的离线网络应用部分为例。
*   Data access, when a user interacts with a more data-intensive interface. Sometimes, part of the slowness of the interface is related to your server collecting data from the database and sending it through the network. You can also use a cache, but you may have to be more careful because interface caching is one thing and data caching is another. People can tolerate one or two hours with an old interface, but not with old data.

    ### 注

    安全至关重要。向您的用户提供 HTTPS 访问权限，让他们对自己的隐私感到放心。

除了这些限制之外，还有降低性能的安全问题。例如，在隐私方面，你必须选择 HTTPS，这意味着良好的证书和良好的服务器配置，以避免糟糕的密码。这反过来意味着一些用户可能无法访问应用，并且服务器和客户端之间的数据交换会稍微慢一点。

如果您想确保从服务器传输到最终用户的数据不受损害，这是一项要求。然而，这实际上是不够的，因为用户还必须拥有最新的浏览器和良好的配置。最近发现了很多 SSL 的弱点，可以通过更新浏览器来避免。

网络不是为了安全而设计的；它是在假设每个人都有良好意图的情况下设计的，这绝对是错误的。当您的用户使用公共热点(从咖啡店、商场或机场)访问您的应用时，他们很容易受到隐私问题的影响。攻击者可以嗅探网络流量，并试图找到密码，或者将自己附加到一个打开的会话中，从而能够冒充用户。

获得一个安全的连接很重要，但是它可能会降低性能，还会减少您的每台服务器可以处理的用户数量。这可能是安全的代价。认为 HTTPS 总是慢一点？试试[http://www.httpvshttps.com/](http://www.httpvshttps.com/)。

另外，不要忘记你的数据库。确保您没有任何默认密码，并且您只允许从您的应用进行访问(不要让互联网上的每个人都可以访问)。

安全并不止于此。由于您的应用是一个已知的网络位置，您可能会成为攻击的受害者。也许你认为把服务器放在防火墙后面，只是把流量重定向到用户需要的端口(比如 HTTP 和 HTTPS)就够了，但是不要忘记**拒绝服务** ( **DoS** )攻击。一个拥有攻击网络的攻击者可以通过强迫你的应用忙于处理它们，以至于真正的用户无法访问和使用它，从而使你的应用瘫痪。这让他们觉得自己表现不佳，这是你无法避免的。

例如，GitHub 在 2015 年 3 月面临来自中国的攻击。持续了几天。他们无法避免它，只能通过试图转移交通来缓解它。有些人受到了很大的影响。随着您的应用变得越来越大，更多的攻击者可能会对您的信息感兴趣，或者只是拒绝访问它。

## 客户限额

客户也有限制。他们可能正在使用一个你不知道或者不能确定的操作系统。这也适用于浏览器、安装的应用以及甚至位置。

### 注

永远不要相信浏览器发送的用户代理。另外，永远不要从中推断任何信息。它可以被锻造成任何东西。笔记本电脑可以非常容易地模仿上个世纪的诺基亚手机——不需要黑客攻击！

这是每个开发人员都必须遵守的规则:永远不要相信客户端。我并不是说得不好，但你必须确定你掌握的信息。例如，您的界面在表单中有验证，并且您确定它们在提交之前验证正确，对吗？错了！永远不要相信客户。

另外，永远不要相信客户和你之间的联系。在服务器端再次验证信息。如果可能的话，通过使用 Node.js，使用相同的代码在两端进行验证，避免重复的代码。例如，您可以使用一些代码来验证 web 视图中的表单，这些代码也可以在服务器中使用。别忘了！Node.js 是 JavaScript。如果这是一段复杂的代码或模块，您可能需要查看浏览器([http://browserify.org/](http://browserify.org/))。

表单验证应该在双方进行，以给出性能的感觉，并实际上避免常见的错误。您不应该在客户端验证所有内容，但至少要检查货币字段是否实际上有数字而不是文本，并确认所有必需的字段都有正确的值。这减少了提交给服务器和服务器回复错误的往返行程。

除了应用的极限，还有你无法控制的极限之外。用户总是会责怪你，也许大多数时候这不是你的应用的错。您是否准备好接受来自蜂窝网络的客户端的间歇性连接？我指的不是 3G，因为这个可以足够稳定。我指的是 GPRS 连接。

你有没有一个成熟的手机应用，它没有超过 300 像素宽的屏幕，行为像我高中的 TI-83？你希望每个人都使用最新的手机，它的屏幕比你的上网本大，处理器也比你的上网本强吗？正是在这里，表演感被注意到了。

一个巨大的应用仅仅通过渲染界面就可以关闭一个较弱的手机。一个便宜的处理器将很难在应用中呈现所有元素并运行所有的 JavaScript。在小屏幕上渲染对它来说将是一个挑战。因此，对于这种类型的屏幕，最好有一个完全不同的界面，并且简单地使用一个自适应界面来实现较小的差异。

用户接受不同的接口，因为他们实际上是以不同的方式与应用交互。他们可能用一个手指放在手机和鼠标上，或者用几个手指放在平板电脑或笔记本电脑上。此外，眼睛和屏幕之间的距离不同，因此分辨率也不同。

因此，为了尽可能获得最佳性能，您应该推出一个更简单的界面。删除用户可能不需要的杂乱信息，例如手机中的信息。只保留重要的行动。如果可能，缓存接口以获得更好的性能感觉。与其看到一个没有进度信息的空白屏幕，不如看到一个旋转的轮子。

如今，网络给了你选择。您可以在不同的系统和网络浏览器上使用不同类型的设备。这对用户来说是好事，但对开发者来说却是可怕的。这种碎片化迫使应用的开发只考虑几个目标，而不是整个市场。

您需要专注于应用的主要目标，并为其开发最佳界面。然后，您可以将焦点转移到其他环境，例如手机和手表上较小的屏幕。不要做一个可以在所有屏幕上运行但在任何一个屏幕上都不是最好的应用。

几年前，应用被复制到所有屏幕上，这实际上是愚蠢的。人们出于不同的目的使用不同的设备。例如，人们不会想在手机上创建一个任务列表，但可能会想检查它并将其标记为完成。这意味着你可以有一个小得多的应用来做用户想要的事情，避免过多的信息和减慢交互和降低体验的风险。

## 浏览器限制

浏览器供应商正在整合努力，让开发人员的生活变得更轻松。几年前，为几个浏览器开发一个网络应用简直是地狱。你通常会关注其中的一两个。如果你关注更多，你的代码会变得更加复杂，性能也会受到影响。通常，随着时间的推移和浏览器版本的更新，应用会变得更慢。

如今，只在一个浏览器中开发应用更安全。应用的大部分(如果不是全部的话)将在其他浏览器上正常运行，这取决于您为 DOM 使用了什么样的抽象(jQuery 就是最好的例子)。然后，您可以做一些改进，您将有一个应用在每个浏览器上平稳运行。

保持这些抽象层是最新的，这对于避免不推荐使用和较慢的代码很重要。浏览器倾向于更频繁地发布版本，并带来更新的开发人员界面，这些抽象利用了这些界面。

![Browser limits](img/4183_07_01.jpg)

前面的截图是一个`jsperf`测试 jQuery 的一些版本。版本其实不是最新的，不过没关系。半信半疑。正如你所看到的，更新的版本表现更好——并不总是如此，但这通常是真的。你可以看到，在这个例子中，最老版本的性能比最新版本差了 77%。

## 性能变量

性能应该被视为选择和变量的混合，您应该根据自己的需求进行调整。这里有一些你应该考虑的变量:

*   选择最好或次好的平台。记住，最好的可能不是对你最好的。
*   定义您的数据结构，明智地选择您的数据库服务器。从大处着眼，规划您将如何应对快速的数据增长。
*   规划应用的模块，不要忘记对每个模块进行测试。创建一个可以复制的开发环境，以便新开发人员更容易更快地开始编程。
*   选择一个目标环境，开始开发。不要开始为每个设备和浏览器开发。

# 总结

应用的性能不受代码和数据库选择的限制。为了为您的应用选择最佳路径，您必须意识到一些限制。这些只是影响应用性能的外部因素，但也有其他因素。

最重要的规则——你不应该忘记——是规划你的步骤。没有好好思考这个就不要发展。一个糟糕的选择会让你以后的生活变得更加艰难，当你不得不解决它的时候。与其一周搞定，不如失去一个小时思考。这实际上是你自己发展表现的一部分。