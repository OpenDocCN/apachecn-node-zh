# 第一章。导言和组成

高性能很难，取决于很多因素。对于开发人员来说，最佳性能应该是一个不变的目标。为了实现这一点，开发人员必须知道他们使用的编程语言，更重要的是，该语言在高负载下的性能，这些负载包括磁盘、内存、网络和处理器的使用。

如果开发人员知道一门语言的弱点，他们就会充分利用它。在一个完美的世界里，由于每项工作都是不同的，开发人员应该为这项工作寻找最好的工具。但是这是不可行的，开发人员不可能知道每一个最好的工具，所以他们必须为每一项工作寻找第二好的工具。如果一个开发人员知道很少的工具，但是掌握了它们，他们就会出类拔萃。

作为一个比喻，锤子是用来钉钉子的，你也可以用它来打碎物体或锻造金属，但你不应该用它来拧螺丝。这同样适用于语言和平台。有些平台非常适合很多工作，但在其他工作中表现很差。这种性能有时可以减轻，但在其他时候，无法避免，您应该寻找更好的工具。

Node.js 不是语言；它实际上是一个建立在 V8 之上的平台，V8 是谷歌的开源 JavaScript 引擎。这个引擎实现了 ECMAScript，它本身就是一种简单且非常灵活的语言。我说“简单”是因为它无法访问网络、访问磁盘或与其他进程对话。它甚至不能停止执行，因为它没有任何退出指令。这种语言需要某种接口模型才能有用。Node.js 通过使用 libuv 公开一个(最好是)非阻塞的 I/O 模型来做到这一点。这个非阻塞应用编程接口允许你访问文件系统，连接到网络服务和执行子进程。

该应用编程接口还有另外两个重要元素:缓冲区和流。由于 JavaScript 字符串对 Unicode 友好，所以引入了缓冲区来帮助处理二进制数据。流被用作简单的事件接口来传递数据。当读取文件内容或接收网络数据包时，缓冲区和流在整个应用编程接口上使用。

一个流是一个模块，类似于网络模块。加载时，它提供对一些基类的访问，这些基类有助于创建可读、可写、双工和转换流。这些可用于以简化和统一的格式执行各种数据操作。

当将二进制数据格式转换为其他格式时，缓冲模块很容易成为您最好的朋友，例如 JSON。多种读写方法可以帮助您将 8 位到 8 字节长的整数和浮点数(有符号或无符号、大端或小端)进行转换。

大部分平台都被设计得简单、小巧、稳定。它已经设计好并准备好创建一些高性能应用。

# 性能分析

绩效是在规定的时间内，用规定的资源完成的工作量。可以使用一个或多个取决于性能目标的指标对其进行分析。目标可以是低延迟、低内存占用、减少处理器使用，甚至降低功耗。

性能分析的行为也被称为 **剖析**。概要分析对于优化应用非常重要，可以通过检测应用的源或实例来实现。通过检测源代码，开发人员可以发现常见的性能弱点。通过检测应用实例，他们可以在不同的环境中测试应用。这种仪器也可以被称为 **标杆**。

Node.js 以速度快著称。其实没那么快；这只是你的资源允许的最快速度。Node.js 最擅长的是不会因为一个输入输出任务而阻塞你的应用。在 Node.js 应用中，对性能的感知可能会产生误导。在某些其他语言中，当应用任务被阻止时(例如，由于磁盘操作)，所有其他任务都会受到影响。在 Node.js 的情况下，这种情况通常不会发生。

有些人认为平台是单线程的，这是不正确的。您的代码在一个线程上运行，但是还有几个线程负责输入/输出操作。由于与处理器的性能相比，这些操作非常慢，所以它们在单独的线程上运行，并在获得应用的信息时通知平台。阻止输入/输出操作的应用表现不佳。由于 Node.js 不会阻塞 I/O，除非您希望它阻塞，因此可以在等待 I/O 的同时执行其他操作。这大大提高了性能。

V8 是一个开源的 Google 项目，是 Node.js 背后的 JavaScript 引擎，它负责编译和执行 JavaScript，以及管理应用的内存需求。它的设计考虑到了性能。V8 遵循几个设计原则来提高语言性能。该引擎有一个探查器和现有的最好、最快的垃圾收集器之一，这是其性能的关键之一。它也不把语言编译成字节码；它在第一次执行时直接将其编译成机器代码。

开发环境中良好的背景将大大增加开发高性能应用的成功机会。了解解引用是如何工作的，或者为什么变量应该避免切换类型，这一点非常重要。以下是你想要遵循的其他有用的提示。您可以使用像 JSCS 这样的风格指南和像 JSHint 这样的提示来为您自己和您的团队实施它们。以下是其中的一些:

*   编写小函数，因为它们更容易优化
*   使用单态参数和变量
*   首选数组来操作数据，因为整数索引元素更快
*   尽量有小物件，避免长的原型链
*   避免克隆对象，因为大对象会降低操作速度

## 监测

在应用进入生产模式后，性能分析变得更加重要，因为用户会比你要求更高。用户不会接受超过一秒钟的任何事情，监控应用随时间和某些特定负载的行为将是极其重要的，因为它将向您指出您的平台正在失败或下一步将失败的地方。

是的，你的申请可能会失败，你能做的最好的就是做好准备。创建备份计划，拥有备用硬件，并创建服务探测。本质上，预测所有你能想到的场景，记住你的应用仍然会失败。以下是您应该监控的一些场景和方面:

*   在生产环境中，应用的使用对于了解应用在数据大小或内存使用方面的发展方向至关重要。重要的是，您要仔细定义源代码探测器来监控指标，不仅是性能指标，如每秒请求数或并发请求数，还包括错误率和每个服务请求的异常百分比。您的应用发出错误，有时会抛出异常；这很正常，你不应该忽视它们。
*   不要忘记基础设施的其余部分。如果您的应用必须以高标准运行，您的基础架构也应该如此。您的服务器电源应该是不间断且稳定的，因为不稳定会以更快的速度降低您的硬件。
*   明智地选择磁盘，因为速度更快的磁盘更贵，而且通常存储空间更小。然而，有时候，当您的应用不需要那么多存储并且速度被认为更重要时，这实际上是一个不错的决定。但不要只看每美元的千兆字节数。有时候，更重要的是看每美元每秒的千兆比特数。
*   还有，你的服务器温度和服务器机房也要监控。高温会降低性能，并且您的硬件有工作温度限制。物理和虚拟的安全性也非常重要。一切都取决于高性能的标准，因为一个停止为用户服务的应用根本没有运行。

# 获得高性能

规划对于获得尽可能好的结果至关重要。高性能是从头开始构建的，从您如何规划和开发开始。这显然取决于物理资源，因为当您没有足够的内存来完成任务时，您无法很好地执行，但这也在很大程度上取决于您如何规划和开发应用。掌握工具会比仅仅使用它们带来更好的性能机会。

从发展之初就把标准定得很高，会迫使规划更加审慎。数据库层的一些不良规划确实会降低性能。此外，谨慎的规划会使开发人员更有意识地思考用例和编程。

高性能是当你不得不考虑一组新的资源(处理器、内存、存储)时，因为你所拥有的一切都被耗尽了，而不仅仅是因为一个资源被耗尽了。当使用少量处理器并且磁盘已满时，高性能应用不应该需要第二台服务器。在这种情况下，您只需要更大的磁盘。

如今，应用不能被设计成单一的。越来越多的用户实施分布式体系结构，或者至少一个可以通过拥有多个实例来分配负载的体系结构。这一点在规划之初非常重要，因为更改已经投入生产的应用会更加困难。

随着时间的推移，大多数常见的应用的性能都会变差，这不是因为处理能力不足，而是因为数据库和磁盘上的数据量不断增加。您会注意到，内存的重要性增加了，后备磁盘对于避免停机变得至关重要。应用能够横向扩展是非常重要的，无论是跨服务器还是跨区域共享数据。

分布式体系结构也提高了性能。地理上分布的服务器可以更加靠近客户端，并提供性能感知。此外，由更多服务器分布的数据库将整体处理更多流量，并允许 DevOps 实现零停机目标。这对于维护也非常有用，因为可以关闭节点以获得支持，而不会影响应用。

## 测试和基准测试

要知道一个应用在特定环境下是否表现良好，我们有对其进行测试。这种测试称为基准测试。基准测试很重要，它是针对每个应用的。即使对于相同的语言和平台，不同的应用可能会有不同的表现，这可能是因为应用某些部分的结构方式，也可能是因为数据库的设计方式。

分析性能将表明您的应用的瓶颈，或者，如果可能的话，应用中表现不佳的部分。这些都是需要改进的地方。不断尝试改进性能最差的部分将提升应用的整体性能。

有很多工具，有些更具体或专注于 JavaScript 应用，如 benchmarkjs([http://benchmarkjs.com/](http://benchmarkjs.com/))和Ben([https://github.com/substack/node-ben](https://github.com/substack/node-ben))，还有一些更通用，如 ab([http://httpd.apache.org/docs/2.2/programs/ab.html](http://httpd.apache.org/docs/2.2/programs/ab.html))和httpload([https://github.com/perusio/httpload](https://github.com/perusio/httpload))。根据目标不同，基准测试有几种类型，如下所示:

*   **负载测试**是最简单的标杆形式。这样做是为了找出应用在特定负载下的表现。您可以测试并找出应用每秒接受多少连接，或者应用可以处理多少流量字节。可以通过查看外部性能(如流量)和内部性能(如使用的处理器或消耗的内存)来检查应用负载。
*   **浸泡测试**是用来查看应用在更长的时间段内的表现。当应用随着时间的推移趋于降级，需要进行分析以了解它的反应时，就会这样做。这种类型的测试对于检测内存泄漏很重要，因为一些应用在一些基本测试中表现良好，但是随着时间的推移，内存泄漏及其性能会下降。
*   **尖峰测试**在负载快速增加时使用，以查看应用的反应和执行情况。这个测试在可能有尖峰用法的应用中非常有用和重要，操作员需要知道应用将如何反应。推特是一个很好的例子，它的应用环境可能会受到使用高峰的影响(在体育或宗教日等世界活动中)，并且需要知道基础设施将如何处理它们。

随着应用的增长，所有这些测试都会变得更加困难。因为你的用户群变大了，你的应用也扩展了，你失去了用你拥有的资源进行负载测试的能力。为这一时刻做好准备是很好的，尤其是在应用用户开始负责持续测试负载时，准备好监控性能并跟踪浸润和峰值。

## 应用中的成分

由于对高性能应用的持续需求，合成变得非常重要。组合是一种实践，您将应用分成几个更小、更简单的部分，使它们更容易理解、开发和维护。这也使它们更容易测试和改进。

避免创建庞大、单一的代码库。当您需要进行更改时，它们不能很好地工作，如果您需要测试和分析代码的任何部分来改进它并使其性能更好，它们也不能很好地工作。

Node.js 平台帮助您——在某些方面，迫使您——编写代码。 **Node.js 包管理器** ( **NPM** )是一个很棒的模块发布服务。你可以下载别人的模块，也可以发布自己的模块。发布的模块数以万计，这意味着在大多数情况下，您不必重新发明轮子。这很好，因为您可以避免在创建模块上浪费时间，并使用已经在生产中并被许多人使用的模块，这通常意味着 bug 将被更快地跟踪，改进将被更快地交付。

Node.js 平台允许开发人员轻松地分离代码。您不必这样做，因为平台不会强迫您这样做，但是您应该尝试并遵循一些好的实践，例如下面几节中描述的实践。

### 使用 NPM

除非需要，否则不要重写代码。慢慢尝试一些可用的模块，选择一个适合你的。这降低了编写错误代码的可能性，并有助于发布拥有更大用户群的模块。bug 会更早被发现，不同环境中的更多人会测试修复。此外，您将使用更具弹性的模块。

在开始使用一些模块后，一个重要且被忽略的任务是跟踪变化，并尽可能保持使用最近的稳定版本。如果一个依赖模块已经一年没有更新了，你可以稍后发现一个问题，但是你将很难弄清楚相隔一年的两个版本之间发生了什么变化。Node.js 模块往往会随着时间的推移而改进，API 的变化并不罕见。务必谨慎升级，不要忘记测试。

### 分离你的代码

同样，您应该始终将代码分成更小的部分。Node.js 以一种非常简单的方式帮助您做到这一点。您不应该有大于 5 kB 的文件。如果有，你最好考虑分了它。同样，作为一个好的规则，每个用户定义的对象都应该有自己单独的文件。相应地命名您的文件:

```js
    // MyObject.js
    module.exports = MyObject;

    function MyObject() {
      // …
    }
    MyObject.prototype.myMethod = function () { … };
```

另一个好的规则是检查你是否有一个比它应该大的文件；也就是说，它应该很容易被应用的新手在不到 5 分钟的时间内阅读和理解。如果没有，这意味着它太复杂了，以后跟踪和修复 bug 会更难。

### 类型

请记住，以后，当您的应用变得庞大时，您将像一个新的开发人员一样打开一个文件来修复一些东西。你不可能记住应用的所有代码，你需要快速吸收一个文件行为。

### 拥抱异步任务

平台是设计成异步的，你不应该违背。有时，很难进行一些递归任务，甚至很难在一系列必须连续运行的任务中循环。您应该避免创建处理异步任务的模块，因为有一些模块已经被成千上万的人使用和测试过。例如，`async`是帮助开发人员表现更好的一种简单且非常实用的方式，学习曲线非常平滑:

```js
    async.each(users, function (user, next) {
        // do something on each user object
        return next();
    }, function (err) {
        // done!
    });
```

这个模块有很多类似于在数组对象中找到的方法，比如 map、reduce、filter 等等，但是都是异步迭代的。当您的应用变得更加复杂并且一些用户操作需要一些序列化任务时，这非常有用。错误处理也正确完成，执行停止也按预期完成。该模块有助于运行串行或并行任务。

此外，通常会迫使开发人员嵌套调用并进入回调地狱的串行任务可以简单地避免。例如，当您需要在包含多个查询的数据库上执行事务时，这尤其有用。

编写异步代码时的另一个常见错误是抛出错误。回调在它们被定义的范围之外被调用，所以你不能把回调放在一个`try` / `catch`块里面。因此，避免这样做，除非这是一个非常严重的错误，应该使您的应用停止和退出。在 Node.js 中，抛出一个异常而没有捕捉到它将会触发一个`uncaughtException`事件。

该平台有一个大多数开发人员都同意的规则——所谓的错误优先回调风格。这条规则非常重要，因为它允许更容易地重用您的代码。即使您有一个不可能抛出错误的函数，或者当您只是不想让它抛出并在函数内部使用某种错误处理时，您的回调应该总是为错误事件保留第一个参数，如果它总是为空的话。这将允许您的功能与`async`模块一起使用。此外，其他开发人员在调试时会依赖这种风格，因此总是将第一个参数作为错误对象反转。

另外，您应该始终将函数的最后一个参数保留为回调。永远不要在回调后定义参数:

```js
    function mySuperFunction(arg1, ..., argN, next) {
        // do some voodoo
        return next(null, my_result); // 1st argument reserved for error
    }
```

### 使用库函数

库函数是你应该使用的另一种类型的模块。它们有助于处理重复性任务，每个开发人员都必须执行这些任务。其中一些重复的任务可以不费吹灰之力完成，只需使用 lodash 或下划线中的库函数。它们是代码的重要组成部分，有很好的优化，你甚至不用去考虑。许多循环任务，例如根据对象键在数组中查找对象，或者将对象数组映射到每个对象的键数组，都是这些库中的单行任务。首先阅读文档，以避免使用库和没有充分利用其潜力。

虽然这些类型的模块很有用，但是如果选择不当，也会降低性能。有些模块旨在帮助开发人员完成某些任务，但不以性能为目标——只是为了方便。换句话说，这些模块可以帮助你更快地开发，但是你不应该忘记每个功能的复杂性。否则会因为忘记的复杂性而多次调用同一个函数，而不是调用一次保存结果。

### 类型

请记住，当您使用一两个用户开发应用并进行测试时，并不会看到高性能。那时，应用运行速度很快，因为数据大小和用户数量仍然很少。稍后你可能会后悔你的一些设计决定。

### 使用功能规则

功能在这个平台中非常重要。这并不奇怪，因为语言是功能性的，具有一流的功能。在编写函数时，您应该遵循一些规则，这将使您以后调试或优化函数时的生活更加轻松。他们还避免了一些错误，因为他们试图执行一些共同的结构。同样，您可以使用以下方法来执行这些规则，例如JSCS([http://jscs.info/](http://jscs.info/)):

1.  请务必命名您的函数，尤其是当它们是用作回调的闭包时。这允许您在代码中断时在堆栈跟踪中识别它们。此外，它们允许新开发人员快速知道该函数应该做什么。不过，要避免长名字:

    ```js
    socket.on("data", function onSocketData(data) {
        // …
    });
    ```

2.  不要嵌套你的条件，尽早回归。如果你有一个条件必须在函数中返回一些东西，如果你返回了，你不必使用`else`语句。您还可以避免新的缩进级别，从而减少代码并简化其修订。如果你不这样做，你最终会进入一个条件地狱，如果你有两个或更多的条件要满足，你会有几个等级:

    ```js
    // do this
    if (someCondition) {
        return false;
    }
    return someThing;

    // instead of this:
    if (someCondition) {
        return false;
    } else {
        return someThing;
    }
    ```

3.  创建小而简单的函数。不要让你的功能超出你的屏幕所能处理的范围。即使您的任务不能被重用，也要将该功能拆分成更小的功能。把放到一个新的模块里发布就更好了。这样，如果您需要，可以在前端重用它们。这也可以让引擎在无法优化之前的大功能时，优化一些较小的功能。同样，如果您不想让开发人员在能够接触任何东西之前阅读您的应用代码一两周，这一点很重要。

### 测试您的模块

测试你的模块是一项艰苦的工作，通常会被忽视，但是对你的模块进行测试是非常重要的。第一个是硬的。找一个自己喜欢的测试工具，比如海誓山盟，柴，或者摩卡。如果您不知道如何开始，请阅读一个模块的文档或另一个模块的测试代码。但是不要放弃测试。

### 注

如果你需要帮助，阅读前面提到的测试工具的网站，因为它们通常会帮助你开始。或者，你可以看看伊戈尔在旗语上的帖子。

开始添加一两个测试后，还会有更多的测试。从一开始测试你的模块的一个很大的优点是，当你发现一个 bug 时，你可以为它做一个测试用例，以便能够重现它并在将来避免它。

代码覆盖率并不重要，但是可以帮助您了解您的测试如何覆盖您的模块代码库，如果您只是测试一小部分的话。有一些覆盖模块，如`istanbul`或`jscoverage`；选择最适合你的。代码覆盖率是与测试一起完成的，所以如果你不测试它，你将看不到覆盖率。

因为您可能想要提高应用的性能，所以应该查看每个依赖模块的改进。这只有在你测试它们的情况下才能做到。依赖版本管理非常重要，很难跟踪新版本和变化，但它们可能会给你带来一些好消息。有时，模块被重构，性能得到提升。数据库访问模块就是一个很好的例子。

# 总结

Node.js 和 NPM 一起为开发高性能应用提供了一个非常好的平台。由于它们背后的语言是 JavaScript，而如今大多数应用都是网络应用，这些组合使它成为一个更有吸引力的选择，因为它少了一种需要学习的服务器端语言(如 PHP 或 Ruby)，并且最终可以允许开发人员在客户端和服务器端共享代码。此外，前端和后端开发人员可以共享、阅读和改进彼此的代码。许多开发人员选择了这个公式，并从客户端带来了他们的许多习惯。其中一些习惯并不适用，因为在服务器端，异步任务必须占主导地位，因为连接了许多客户端(而不是一个)，性能变得至关重要。

在下一章中，我们将介绍一些开发模式，这些模式有助于应用保持简单、快速和可扩展，因为越来越多的客户端出现并开始给您的基础架构带来压力。